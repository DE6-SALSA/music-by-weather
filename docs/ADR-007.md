# ADR-007: [staging í…Œì´ë¸” ê¸°ëŠ¥ ê°•í™” ë° ì‚¬ìš© ì—¬ë¶€]

** ğŸ“… ë‚ ì§œ**: 2025-07-25

** ğŸ¯ ì£¼ì œ**: ë°ì´í„° ê²€ì¦ ë¡œì§ì„ **Python ê¸°ë°˜ â†’ SQL ê¸°ë°˜ Staging í…Œì´ë¸” ë°©ì‹**ìœ¼ë¡œ ì „í™˜

## ğŸ“ ìƒí™© (Context)

- ê¸°ì¡´ íŒŒì´í”„ë¼ì¸ì—ì„œëŠ” APIë¡œ ë°›ì€ ë°ì´í„°ë¥¼ **Python(Pandas)ì—ì„œ ìœ íš¨ì„± ê²€ì¦ í›„** Redshiftì— ì ì¬í–ˆë‹¤.
- í•˜ì§€ë§Œ ì´ ë°©ì‹ì€:
    1. Python ìª½ ì½”ë“œê°€ ë³µì¡í•´ì§€ê³ , ê²€ì¦ ë¡œì§ì´ ë¶„ì‚°ë¨
    2. ê²€ì¦ ì‹¤íŒ¨ ë°ì´í„°ë¥¼ ì¶”ì Â·ê´€ë¦¬í•˜ê¸° ì–´ë ¤ì›€
    3. ë°ì´í„° í’ˆì§ˆ ëª¨ë‹ˆí„°ë§ ë° ê°ì‚¬(Audit)ê°€ í˜ë“¦
        
        â†’ ì¦‰, **ë°ì´í„° í’ˆì§ˆ ê´€ë¦¬ ë° ë¶„ì„ ê°€ì‹œì„±ì´ ë¶€ì¡±**í–ˆë‹¤.
        

## ğŸ’¡ ê³ ë ¤ëœ ì˜µì…˜

1. **ê¸°ì¡´ ë°©ì‹ ìœ ì§€**
    - Pandasë¡œ ê²€ì¦ í›„ Redshiftì— INSERT
    - ì¥ì : êµ¬í˜„ ë‹¨ìˆœ, ë¹ ë¥¸ ì†ë„
    - ë‹¨ì : ì‹¤íŒ¨ ë°ì´í„° ì¶”ì  ë¶ˆê°€, ìš´ì˜/ë¶„ì„ ë¡œê·¸ ë¶€ì¡±
2. **Staging í…Œì´ë¸”ì„ ì´ìš©í•œ SQL ê¸°ë°˜ ê²€ì¦** âœ… **(ì„ íƒ)**
    - S3 â†’ Redshift Staging â†’ SQLë¡œ ê²€ì¦ ë° ë¶„ë¥˜
    - ì¥ì :
        - Redshift ë‚´ì—ì„œ ì¼ê´€ëœ í’ˆì§ˆ ê²€ì¦ ê°€ëŠ¥
        - ì‹¤íŒ¨ ë°ì´í„°(`bad_records`)ë¥¼ ë³„ë„ í…Œì´ë¸”ì— ê¸°ë¡
        - Superset/BIì—ì„œ í’ˆì§ˆ ëª¨ë‹ˆí„°ë§ ê°€ëŠ¥
    - ë‹¨ì : SQL ì¿¼ë¦¬ ì¶”ê°€, COPY í›„ ê²€ì¦ ë‹¨ê³„ê°€ ëŠ˜ì–´ë‚˜ ì•½ê°„ì˜ ì§€ì—° ë°œìƒ

## âœ… ê²°ì • (Decision)

- **Staging í…Œì´ë¸”(`raw_data.top_tag5_staging`)ì„ ì‚¬ìš©í•˜ì—¬ ë°ì´í„° ê²€ì¦ ë° ë¶„ë¥˜ë¥¼ ìˆ˜í–‰í•œë‹¤.**
- ê²€ì¦ í›„:
    - ìœ íš¨í•œ ë°ì´í„° â†’ `analytics_data.top_tag5`
    - ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„° â†’ `raw_data.bad_records_top_tag5` (error_reason í¬í•¨)
- ê¸°ì¡´ì˜ `raw_data.top_tag5`ëŠ” ë” ì´ìƒ ìš´ì˜ìš©ìœ¼ë¡œ ì‚¬ìš©í•˜ì§€ ì•Šê³ , ëª¨ë“  ìš´ì˜ ë°ì´í„°ëŠ” `analytics_data.top_tag5`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê´€ë¦¬í•œë‹¤.

## ğŸ“Œ ê·¼ê±° (Rationale)

- **ë°ì´í„° í’ˆì§ˆ ëª¨ë‹ˆí„°ë§ ê°€ëŠ¥** â†’ ì‹¤íŒ¨ ë°ì´í„°ë¥¼ `bad_records`ì— ê¸°ë¡
- **ìš´ì˜ê³¼ ë¶„ì„ì˜ ë¶„ë¦¬** â†’ Raw/Staging/Analytics ìŠ¤í‚¤ë§ˆë¥¼ ë‹¨ê³„ë³„ë¡œ êµ¬ë¶„
- **ETL í‘œì¤€í™”** â†’ ë°ì´í„° í’ˆì§ˆ ê²€ì¦ ì±…ì„ì„ SQLë¡œ ì¼ì›í™”, Python ë¡œì§ ë‹¨ìˆœí™”
- **í™•ì¥ì„±** â†’ ì¶”í›„ Data Quality Rule ì¶”ê°€ ì‹œ SQLë§Œ ë³€ê²½í•˜ë©´ ë¨

## ğŸ“ˆ ê¸°ëŒ€ íš¨ê³¼

1. **ë°ì´í„° í’ˆì§ˆ ê°œì„ **
    - Null ê°’, ì¤‘ë³µ, ë¹„ì •ìƒ ë°ì´í„° ê²€ì¶œ ë° ê´€ë¦¬ ê°€ëŠ¥
2. **ìš´ì˜ ê°€ì‹œì„± í™•ë³´**
    - `bad_records_top_tag5`ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì´ìƒì¹˜ ëŒ€ì‹œë³´ë“œ êµ¬ì„± ê°€ëŠ¥
3. **ìœ ì—°í•œ í™•ì¥ì„±**
    - ê²€ì¦ ë¡œì§ì„ SQL ê¸°ë°˜ìœ¼ë¡œ ì‰½ê²Œ ì¶”ê°€/ë³€ê²½ ê°€ëŠ¥

## ğŸ§© ë³€ê²½ëœ íŒŒì´í”„ë¼ì¸ íë¦„

```mermaid
graph TD
    A[Extract Tracks] --> B[Enrich with Tags]
    B --> C[Save to CSV/Parquet in S3]
    C --> D[Copy to raw_data.top_tag5_staging]
    D -->|Valid Data| E[analytics_data.top_tag5]
    D -->|Invalid Data| F[raw_data.bad_records_top_tag5]
```

## ğŸ’¬ ì¶”ê°€ ì°¸ê³ ì‚¬í•­

- ê¸°ì¡´ `raw_data.top_tag5` ë°ì´í„°ëŠ” **ëª¨ë‘ `analytics_data.top_tag5`ë¡œ ì´ê´€** ì™„ë£Œ
- ìƒˆë¡œìš´ ë¡œê·¸ í…Œì´ë¸” `analytics_data.format_compare`ë¥¼ í†µí•´ CSV/Parquet ì„±ëŠ¥ ë¹„êµ ì‹¤í—˜ë„ ì§„í–‰
- Supersetì„ í™œìš©í•´ `bad_records_top_tag5`ì™€ `format_compare`ë¥¼ ì‹œê°í™” ë° ëª¨ë‹ˆí„°ë§ ì˜ˆì •
</aside>
